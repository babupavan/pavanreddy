pipeline {
    agent any

    triggers {
        // Trigger at 08:06 and 08:10 UTC (which corresponds to 14:06 and 14:10 IST)
        cron('00,04 09 * * *')  // Adjusted for UTC if your Jenkins server is in UTC
    }

    environment {
        AWS_DEFAULT_REGION = 'ap-south-1'
        TZ = 'Asia/Kolkata'  // Set timezone to IST (Indian Standard Time)
        INSTANCEID = credentials('INSTANCEID')  // Retrieve the INSTANCEID secret from Jenkins credentials
    }

    stages {
        stage('Start/Stop EC2 Instance') {
            steps {
                script {
                    // Print the current system time and time zone
                    echo "Current system time: ${new Date().format("HH:mm", TimeZone.getTimeZone("Asia/Kolkata"))}"
                    echo "Jenkins Server Timezone: ${TimeZone.getDefault().getDisplayName()}"

                    // Retrieve the current time in Kolkata time zone (Asia/Kolkata)
                    def currentTime = new Date().format("HH:mm", TimeZone.getTimeZone("Asia/Kolkata"))
                    echo "Current time in IST: $currentTime"

                    // Debug: Log the INSTANCEID to make sure it's being retrieved properly
                    echo "Instance ID: $INSTANCEID"

                    // Use the credentials stored in Jenkins for AWS access
                    withCredentials([aws(credentialsId: 'aws-credentials')]) {
                        if (currentTime == "09:00") {
                            echo "Starting EC2 instance with ID $INSTANCEID..."
                            sh """
                                aws ec2 start-instances --instance-ids ${INSTANCEID}
                                aws ec2 wait instance-running --instance-ids ${INSTANCEID}
                                echo "EC2 instance started."
                            """
                        } else if (currentTime == "09:04") {
                            echo "Stopping EC2 instance with ID $INSTANCEID..."
                            sh """
                                aws ec2 stop-instances --instance-ids ${INSTANCEID}
                                aws ec2 wait instance-stopped --instance-ids ${INSTANCEID}
                                echo "EC2 instance stopped."
                            """
                        } else {
                            echo "No action required at this time."
                        }
                    }
                }
            }
        }
    }
}
